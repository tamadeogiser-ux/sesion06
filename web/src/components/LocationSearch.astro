---
/**
 * Componente LocationSearch
 * 
 * Input para buscar ubicaciones
 * - Validaci√≥n en tiempo real
 * - Sugerencias (preparado para autocomplete)
 * - Accesible con ARIA
 */

interface Props {
  placeholder?: string;
  onSearch?: (query: string) => void;
}

const { placeholder = "Buscar ciudad..." } = Astro.props;
---

<form class="location-search" id="location-search-form">
  <div class="location-search__wrapper">
    <input
      type="text"
      class="location-search__input"
      placeholder={placeholder}
      aria-label="Buscar ubicaci√≥n"
      autocomplete="off"
      required
    />
    <button
      type="submit"
      class="location-search__button btn btn-primary btn-sm"
      aria-label="Buscar"
    >
      üîç
    </button>
  </div>
  
  <ul class="location-search__results" id="search-results" role="listbox"></ul>
</form>

<script>
  const form = document.getElementById('location-search-form');
  const input = form?.querySelector('input');
  const resultsList = document.getElementById('search-results');
  
  const API_URL = 'http://localhost:3000';
  
  // Debounce para no hacer muchas peticiones
  let debounceTimer;
  
  // Buscar ciudades desde el backend
  async function searchCities(query) {
    if (query.length < 1) {
      resultsList.innerHTML = '';
      return;
    }
    
    try {
      // Mostrar loading
      resultsList.innerHTML = '<li><span style="padding: var(--space-md); display: block; opacity: 0.5;">üîç Buscando...</span></li>';
      
      console.log('üîç Buscando ciudades:', query);
      const fetchUrl = `${API_URL}/api/cities/search?q=${encodeURIComponent(query)}`;
      console.log('Fetch URL:', fetchUrl);
      
      const response = await fetch(fetchUrl);
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const json = await response.json();
      console.log('Response JSON:', json);
      
      if (!json.success || !json.data) {
        resultsList.innerHTML = '<li><span style="padding: var(--space-md); display: block; opacity: 0.5;">‚ùå No hay resultados</span></li>';
        console.warn('No success o data en respuesta');
        return;
      }
      
      const cities = json.data;
      console.log('Cities found:', cities.length);
      
      if (cities.length === 0) {
        resultsList.innerHTML = '<li><span style="padding: var(--space-md); display: block; opacity: 0.5;">No hay resultados</span></li>';
        return;
      }
      
      resultsList.innerHTML = cities
        .map((city) => `
          <li class="location-search__result" role="option">
            <button 
              type="button"
              class="location-search__result-btn"
              data-lat="${city.lat}"
              data-lon="${city.lon}"
              data-name="${city.name}"
            >
              üìç <span>${city.name}</span>
              ${city.country ? `<span style="opacity: 0.6; font-size: 0.8em;">${city.country}</span>` : ''}
            </button>
          </li>
        `)
        .join('');
      
      // Agregar listeners a los resultados
      resultsList.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', handleCityClick);
      });
      
    } catch (error) {
      console.error('Error buscando ciudades:', error);
      resultsList.innerHTML = '<li><span style="padding: var(--space-md); display: block; opacity: 0.5;">‚ùå Error en b√∫squeda</span></li>';
    }
  }
  
  // Manejar click en ciudad
  function handleCityClick(e) {
    e.preventDefault();
    const btn = e.target;
    const lat = btn.dataset.lat;
    const lon = btn.dataset.lon;
    const name = btn.dataset.name;
    
    // Disparar evento personalizado
    window.dispatchEvent(new CustomEvent('locationSelected', {
      detail: { 
        latitude: parseFloat(lat), 
        longitude: parseFloat(lon),
        name: name
      }
    }));
    
    input.value = name || '';
    resultsList.innerHTML = '';
  }
  
  // Input con debounce
  input?.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    const query = e.target.value;
    
    debounceTimer = setTimeout(() => {
      searchCities(query);
    }, 300);
  });
  
  // Submit del formulario
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const firstResult = resultsList.querySelector('button');
    if (firstResult) {
      firstResult.click();
    }
  });
  
  // Cerrar resultados al hacer click fuera
  document.addEventListener('click', (e) => {
    if (!form?.contains(e.target)) {
      resultsList.innerHTML = '';
    }
  });
</script>

<style>
  .location-search {
    width: 100%;
  }
  
  .location-search__wrapper {
    display: flex;
    gap: var(--space-sm);
    width: 100%;
  }
  
  .location-search__input {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-base);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
    transition: all var(--transition-fast);
  }
  
  .location-search__input:focus {
    outline: none;
    border-color: var(--color-info);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .location-search__button {
    padding: var(--space-sm) var(--space-md);
  }
  
  .location-search__results {
    list-style: none;
    margin: var(--space-xs) 0 0;
    padding: 0;
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }
  
  .location-search__results:not(:empty) {
    display: block;
  }
  
  .location-search__result {
    border-bottom: 1px solid var(--color-border-light);
  }
  
  .location-search__result:last-child {
    border-bottom: none;
  }
  
  .location-search__result-btn {
    width: 100%;
    padding: var(--space-md);
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    transition: background-color var(--transition-fast);
    font-size: var(--font-size-sm);
  }
  
  .location-search__result-btn:hover {
    background-color: var(--color-bg-secondary);
  }
  
  .location-search__result-btn:focus-visible {
    outline: 2px solid var(--color-info);
    outline-offset: -2px;
  }
</style>
